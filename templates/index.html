<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Assistant Entity Manager</title>
    <link href="static/css/styles.css?v={{ version }}" rel="stylesheet">
    <link href="static/css/remixicon.css?v={{ version }}" rel="stylesheet">
    <script src="static/js/translations.js?v={{ version }}"></script>
    <script src="static/js/config.js?v={{ version }}"></script>
    <script src="static/js/alpine.min.js" defer></script>
    <script src="static/js/app.js" defer></script>
    <script>
        // Debug: Check if we're in an iframe and what CSS is loaded
        window.addEventListener('load', function() {
            console.log('Entity Manager loaded');
            console.log('In iframe:', window.self !== window.top);

            // Check all stylesheets
            const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
            stylesheets.forEach((link, index) => {
                console.log(`Stylesheet ${index}:`, link.href);
            });

            // Check if bg-red-600 style exists
            const testDiv = document.createElement('div');
            testDiv.className = 'bg-red-600';
            document.body.appendChild(testDiv);
            const computedStyle = window.getComputedStyle(testDiv);
            console.log('bg-red-600 background color:', computedStyle.backgroundColor);
            document.body.removeChild(testDiv);

            // Check if CSS is actually loaded
            fetch('static/css/styles.css')
                .then(response => response.text())
                .then(css => {
                    console.log('CSS file length:', css.length);
                    console.log('Contains bg-red-600:', css.includes('bg-red-600'));
                    console.log('First 200 chars:', css.substring(0, 200));
                    console.log('Last 200 chars:', css.substring(css.length - 200));

                    // Check stylesheets loaded in document
                    for (let sheet of document.styleSheets) {
                        try {
                            console.log('Stylesheet href:', sheet.href);
                            console.log('Rules count:', sheet.cssRules.length);
                        } catch (e) {
                            console.log('Cannot access stylesheet:', sheet.href, e.message);
                        }
                    }
                });
        });
    </script>
</head>
<body class="bg-gray-50">
    <div x-data="entityManager()" x-init="init()" class="h-screen flex flex-col">
        <!-- Alpha Warning Banner -->
        <div class="bg-red-600 text-white px-4 py-3">
            <div class="max-w-7xl mx-auto flex items-center justify-center space-x-2">
                <i class="ri-alert-line text-xl"></i>
                <span class="font-bold" x-text="t('header.warning_banner')">ALPHA VERSION - DEVELOPMENT ONLY</span>
                <span class="text-sm" x-text="t('header.warning_description')">Do not use in production! This add-on is in early development and may cause issues.</span>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="ri-home-8-line text-2xl text-blue-600"></i>
                        <h1 class="text-2xl font-bold text-gray-900" x-text="t('header.title')">Home Assistant Entity Manager</h1>
                        <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium" x-text="t('header.version_badge')">ALPHA</span>
                        <button @click="window.location.reload()"
                                class="ml-2 p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                                :title="t ? t('buttons.reload') : 'Seite neu laden'">
                            <i class="ri-refresh-line text-lg"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600">
                            <span x-show="stats.total_entities">
                                <i class="ri-database-2-line"></i>
                                <span x-text="stats.total_entities"></span> Entities
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Fixed Top Section -->
        <div class="bg-white border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <!-- Selection Panel -->
                <div class="flex items-center gap-3">
                    <!-- Area Selection -->
                    <div class="flex-1 max-w-xs">
                        <select x-model="selectedArea" @change="onAreaChange()"
                                class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="" x-text="t ? t('filters.select_area') : 'Wähle einen Bereich...'">Wähle einen Bereich...</option>
                            <template x-for="area in areas" :key="area.name">
                                <option :value="area.name">
                                    <span x-text="`${getAreaDisplayName(area)} (${area.entity_count})`"></span>
                                </option>
                            </template>
                        </select>
                    </div>

                    <!-- Domain Selection -->
                    <div class="flex-1 max-w-xs">
                        <select x-model="selectedDomain" @change="onDomainChange()" :disabled="!selectedArea"
                                class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Domain...</option>
                            <option value="all">Alle</option>
                            <template x-for="domain in availableDomains" :key="domain">
                                <option :value="domain" x-text="domain"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="flex items-center gap-2 ml-4">
                        <!-- Skip reviewed filter -->
                        <button @click="skipReviewed = !skipReviewed; onFilterChange()"
                                :class="skipReviewed ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
                                class="px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center gap-1.5"
                                title="Nur unbearbeitete Entities">
                            <i class="ri-eye-off-line"></i>
                            <span>Maintained</span>
                        </button>

                        <!-- Only changes filter -->
                        <button @click="onlyChanges = !onlyChanges; onFilterChange()"
                                :class="onlyChanges ? 'bg-amber-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
                                class="px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center gap-1.5"
                                title="Nur Entities mit Änderungen">
                            <i class="ri-refresh-line"></i>
                            <span>Nur Änderungen</span>
                        </button>

                        <!-- Show disabled filter -->
                        <button @click="showDisabled = !showDisabled; onFilterChange()"
                                :class="showDisabled ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'"
                                class="px-3 py-1.5 text-sm rounded-lg transition-colors flex items-center gap-1.5"
                                title="Deaktivierte Entities anzeigen">
                            <i class="ri-eye-close-line"></i>
                            <span>Deaktivierte</span>
                        </button>
                    </div>

                    <!-- Area name override (only when area selected) -->
                    <div x-show="selectedAreaData && selectedAreaData.area_id" class="flex items-center gap-2 ml-auto">
                        <span class="text-xs text-gray-500">Area:</span>
                        <template x-if="!editingAreaName && selectedAreaData">
                            <code class="text-xs font-mono cursor-pointer hover:underline px-2 py-1 bg-gray-100 rounded"
                                  :class="selectedAreaData && selectedAreaData.has_override ? 'text-blue-700' : 'text-gray-600'"
                                  x-text="selectedAreaData && selectedAreaData.has_override ? selectedAreaData.override_name : (selectedAreaData ? selectedAreaData.name : '')"
                                  @click="startAreaEdit()"></code>
                        </template>
                        <template x-if="editingAreaName">
                            <input type="text"
                                   x-model="areaOverrideName"
                                   @keyup.enter="saveAreaEdit()"
                                   @keyup.escape.stop="cancelAreaEdit()"
                                   @blur="handleAreaBlur($event)"
                                   class="text-xs font-mono px-2 py-1 border border-blue-500 rounded focus:ring-1 focus:ring-blue-500"
                                   placeholder="Area Name"
                                   x-init="$nextTick(() => $el.focus())">
                        </template>
                    </div>
                </div>

                <!-- Summary Bar (shown when results loaded) -->
                <div x-show="changes.length > 0 && !loading" x-cloak class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 text-sm">
                            <!-- Entity counts -->
                            <div class="flex items-center space-x-2">
                                <span class="text-gray-600">Entities:</span>
                                <span class="font-semibold" x-text="totalEntities"></span>
                                <span class="text-xs text-gray-500">(<span x-text="changes.length"></span> <span x-text="t('units.devices')"></span>)</span>
                                <span class="text-gray-400 ml-2">|</span>
                                <span class="text-amber-600 font-semibold ml-2" x-text="needRenameCount"></span>
                                <span class="text-xs text-amber-600" x-text="t('summary.to_change')"></span>
                                <span class="text-gray-400 ml-2">|</span>
                                <span class="text-green-600 font-semibold ml-2" x-text="totalEntities - needRenameCount"></span>
                                <span class="text-xs text-green-600" x-text="t('summary.correct')"></span>
                            </div>

                            <!-- Selection count -->
                            <div x-show="selectedCount > 0 || selectedDeviceCount > 0" class="flex items-center space-x-2 pl-4 border-l">
                                <i class="ri-checkbox-circle-fill text-blue-600"></i>
                                <span class="text-gray-600" x-text="t('summary.selected') + ':'"></span>
                                <span x-show="selectedCount > 0" class="font-semibold text-blue-600">
                                    <span x-text="selectedCount"></span> <span x-text="t('units.entities')"></span>
                                </span>
                                <span x-show="selectedCount > 0 && selectedDeviceCount > 0" class="text-gray-400">+</span>
                                <span x-show="selectedDeviceCount > 0" class="font-semibold text-blue-600">
                                    <span x-text="selectedDeviceCount"></span> <span x-text="t('units.devices')"></span>
                                </span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button @click="selectAll()"
                                    class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors flex items-center">
                                <i class="ri-checkbox-multiple-line mr-1.5"></i>
                                <span x-text="t('buttons.select_all')"></span>
                            </button>
                            <button @click="selectNone()"
                                    class="px-3 py-1.5 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
                                <i class="ri-checkbox-blank-line mr-1.5"></i>
                                <span x-text="t('buttons.select_none')"></span>
                            </button>
                            <button @click="executeChanges()"
                                    :disabled="(selectedCount === 0 && selectedDeviceCount === 0) || executing"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                                <i class="ri-check-line mr-1"></i>
                                <span x-text="getExecuteButtonText()"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollable Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <!-- Loading State -->
            <div x-show="loading" x-cloak class="flex justify-center py-12">
                <div class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="text-gray-600" x-text="t ? t('messages.loading') : 'Loading...'">Loading...</span>
                </div>
            </div>

            <!-- Preview Results -->
            <div x-show="changes.length > 0 && !loading" x-cloak>

                <!-- Device/Entity List -->
                <div class="space-y-4">
                    <template x-for="(deviceGroup, index) in changes" :key="index">
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                            <!-- Device Header -->
                            <div class="bg-gray-50 px-3 py-2 border-b border-gray-200"
                                 :class="[
                                     deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename ? 'bg-amber-50 cursor-pointer' : 'cursor-default',
                                     deviceGroup && deviceGroup.device && deviceGroup.device.selected ? 'ring-2 ring-blue-500' : ''
                                 ]"
                                 @click="deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename && toggleDeviceSelection(deviceGroup.device)">
                                <div x-show="deviceGroup && deviceGroup.device">
                                    <!-- Device Info Row -->
                                    <div class="flex items-center space-x-3">
                                        <!-- Device Selection Checkbox -->
                                        <div>
                                            <div class="w-5 h-5 rounded-full flex items-center justify-center"
                                                 :class="[
                                                     deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename ? 'cursor-pointer' : 'cursor-not-allowed opacity-50',
                                                     deviceGroup && deviceGroup.device && deviceGroup.device.selected ? 'bg-blue-600' : (deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename ? 'bg-gray-300' : 'bg-gray-200')
                                                 ]"
                                                 @click.stop="deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename && toggleDeviceSelection(deviceGroup.device)">
                                                <i class="text-white text-xs"
                                                   :class="deviceGroup && deviceGroup.device && deviceGroup.device.selected ? 'ri-check-line' : ''"></i>
                                            </div>
                                        </div>

                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center space-x-3">
                                                    <div class="relative">
                                                        <i class="ri-cpu-line text-gray-600"></i>
                                                        <a x-show="deviceGroup && deviceGroup.device && deviceGroup.device.id"
                                                           :href="'/config/devices/device/' + (deviceGroup && deviceGroup.device ? deviceGroup.device.id : '')"
                                                           target="_blank"
                                                           class="absolute -top-1 -right-1 text-blue-600 hover:text-blue-700 bg-white rounded-full shadow-sm"
                                                           :title="t('device.open_details')"
                                                           @click.stop>
                                                            <i class="ri-external-link-line text-xs"></i>
                                                        </a>
                                                    </div>
                                                    <div>
                                                        <div class="flex items-center space-x-2">
                                                            <h3 class="font-semibold text-gray-900" x-text="deviceGroup && deviceGroup.device ? deviceGroup.device.current_name : ''"></h3>
                                                        </div>
                                                        <p class="text-xs text-gray-500">
                                                            <span x-show="deviceGroup && deviceGroup.device && deviceGroup.device.manufacturer" x-text="deviceGroup && deviceGroup.device ? deviceGroup.device.manufacturer : ''"></span>
                                                            <span x-show="deviceGroup && deviceGroup.device && deviceGroup.device.model" x-text="deviceGroup && deviceGroup.device && deviceGroup.device.model ? ' • ' + deviceGroup.device.model : ''"></span>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-sm text-gray-500">
                                                        <span x-text="deviceGroup && deviceGroup.entities ? deviceGroup.entities.length : 0"></span> <span x-text="t('units.entities')"></span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Device Renaming Suggestion -->
                                    <div class="flex items-center space-x-4 pt-2 border-t border-gray-200" @click.stop>
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2">
                                                <template x-if="deviceGroup && deviceGroup.device && deviceGroup.device.has_override">
                                                    <span class="text-xs text-gray-500" x-text="t('entity.override') + ':'"></span>
                                                </template>
                                                <template x-if="deviceGroup && deviceGroup.device && !deviceGroup.device.has_override && deviceGroup.device.needs_rename">
                                                    <span class="text-xs text-gray-500" x-text="t('entity.suggestion') + ':'"></span>
                                                </template>
                                                <template x-if="deviceGroup && deviceGroup.device && !deviceGroup.device.editing">
                                                    <code class="text-sm font-mono cursor-pointer hover:underline"
                                                          :class="deviceGroup && deviceGroup.device && deviceGroup.device.has_override ? 'text-blue-700' : 'text-amber-700'"
                                                          x-text="deviceGroup && deviceGroup.device ? (deviceGroup.device.has_override ? deviceGroup.device.override_name : deviceGroup.device.suggested_name) : ''"
                                                          @click="startDeviceEdit(deviceGroup.device)"></code>
                                                </template>
                                                <template x-if="deviceGroup && deviceGroup.device && deviceGroup.device.editing">
                                                    <input type="text"
                                                           x-model="deviceGroup.device.override_name"
                                                           @keyup.enter="saveDeviceEdit(deviceGroup.device)"
                                                           @keyup.escape.stop="cancelDeviceEdit(deviceGroup.device)"
                                                           @blur="handleDeviceBlur($event, deviceGroup.device)"
                                                           class="text-sm font-mono px-2 py-1 border border-amber-500 rounded focus:ring-2 focus:ring-blue-500"
                                                           :placeholder="t('device.new_name')"
                                                           x-init="$nextTick(() => $el.focus())">
                                                </template>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <template x-if="deviceGroup.device && !deviceGroup.device.has_override && deviceGroup.device.needs_rename">
                                                <button x-show="deviceGroup && deviceGroup.device && !deviceGroup.device.editing"
                                                        @click="if (deviceGroup && deviceGroup.device) { deviceGroup.device.override_name = deviceGroup.device.suggested_name; saveDeviceEdit(deviceGroup.device); }"
                                                        class="text-xs text-green-600 hover:text-green-700">
                                                    <i class="ri-check-line mr-1"></i>
                                                    <span x-text="t('entity.accept_suggestion')"></span>
                                                </button>
                                            </template>
                                            <span x-show="deviceGroup && deviceGroup.device && deviceGroup.device.editing" class="text-xs text-gray-500 italic">
                                                <span x-text="t('entity.save_cancel_hint', {save: 'Enter', cancel: 'ESC'})"></span>
                                            </span>
                                            <span x-show="deviceGroup && deviceGroup.device && !deviceGroup.device.needs_rename && !deviceGroup.device.editing" class="text-xs text-green-600 flex items-center">
                                                <i class="ri-checkbox-circle-line mr-1"></i>
                                                <span x-text="t('entity.name_already_correct')"></span>
                                            </span>
                                            <span x-show="deviceGroup && deviceGroup.device && deviceGroup.device.selected" class="text-xs text-blue-600 flex items-center ml-auto">
                                                <i class="ri-checkbox-circle-fill mr-1"></i>
                                                <span x-text="t('entity.selected_badge')"></span>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Device Rename Preview -->
                                    <div x-show="deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename" class="mt-2 space-y-1">
                                        <div class="flex items-center space-x-2">
                                            <i class="ri-arrow-right-line text-amber-500"></i>
                                            <span class="text-sm font-semibold text-amber-700" x-text="t('entity.renaming') + ':'"></span>
                                            <code class="text-sm font-mono text-amber-700" x-text="deviceGroup && deviceGroup.device ? deviceGroup.device.current_name : ''"></code>
                                            <i class="ri-arrow-right-line text-amber-500"></i>
                                            <code class="text-sm font-mono text-green-700 font-semibold" x-text="getDevicePreviewName(deviceGroup.device)"></code>
                                        </div>
                                        <div class="text-xs text-gray-500 ml-6">
                                            <span x-text="t('entity.all_related_entities_note')"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- No Device Header -->
                                <div x-show="deviceGroup && !deviceGroup.device" class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <i class="ri-cpu-line text-gray-400"></i>
                                        <div>
                                            <h3 class="font-semibold text-gray-600" x-text="t('entity.entities_without_device')"></h3>
                                            <p class="text-xs text-gray-500" x-text="t('entity.entities_without_device_desc')"></p>
                                        </div>
                                    </div>
                                    <span class="text-sm text-gray-500">
                                        <span x-text="deviceGroup && deviceGroup.entities ? deviceGroup.entities.length : 0"></span> Entities
                                    </span>
                                </div>
                            </div>

                            <!-- Entities -->
                            <div class="divide-y divide-gray-100">
                                <template x-for="entity in (deviceGroup && deviceGroup.entities ? deviceGroup.entities : [])" :key="entity ? entity.old_id : ''">
                                    <template x-if="entity">
                                    <div class="entity-card hover:bg-gray-50"
                                         :class="[
                                             entity && entity.needs_rename ? 'needs-rename' : 'already-correct',
                                             entity && entity.selected ? 'selected' : '',
                                             deviceGroup && deviceGroup.device && deviceGroup.device.selected ? 'opacity-50 cursor-not-allowed' :
                                             (!entity.needs_rename && entity.has_maintained_label) ? 'opacity-50 cursor-not-allowed' :
                                             (!entity.has_override && entityRequiresManualBasename(entity)) ? 'cursor-not-allowed' : 'cursor-pointer'
                                         ]"
                                         @click="!(deviceGroup && deviceGroup.device && deviceGroup.device.selected) && entityCanBeSelected(entity) && toggleSelection(entity)">
                                        <div class="p-3">
                                            <div class="flex items-center space-x-3">
                                                <!-- Selection Indicator -->
                                                <div class="selection-indicator">
                                                    <div class="w-5 h-5 rounded-full flex items-center justify-center"
                                                         :class="[
                                                             entity && entity.selected ? 'bg-blue-600' :
                                                             (deviceGroup && deviceGroup.device && deviceGroup.device.selected) || !entityCanBeSelected(entity) ? 'bg-gray-200' : 'bg-gray-300',
                                                             (deviceGroup && deviceGroup.device && deviceGroup.device.selected) || !entityCanBeSelected(entity) ? 'cursor-not-allowed' : 'cursor-pointer'
                                                         ]">
                                                        <i class="text-white text-xs"
                                                           :class="entity && entity.selected ? 'ri-check-line' : ''"></i>
                                                    </div>
                                                </div>

                                                <!-- Entity Info -->
                                                <div class="flex-1">
                                                    <div class="flex-1">
                                                        <!-- Entity ID Line -->
                                                        <div class="flex items-center space-x-2 text-sm">
                                                            <code class="font-mono text-gray-700" x-text="entity ? entity.old_id : ''"></code>
                                                            <template x-if="entity && entity.needs_rename && (entity.has_override || !entityRequiresManualBasename(entity))">
                                                                <span class="flex items-center text-amber-600">
                                                                    <i class="ri-arrow-right-line mx-1"></i>
                                                                    <code class="font-mono font-semibold" x-text="entity ? entity.new_id : ''"></code>
                                                                </span>
                                                            </template>
                                                        </div>

                                                        <!-- Friendly Name Line -->
                                                        <div class="flex items-center space-x-2 text-sm mt-1">
                                                            <span class="text-gray-600" x-text="entity ? entity.current_name : ''"></span>
                                                            <template x-if="entity && entity.needs_rename && (entity.has_override || !entityRequiresManualBasename(entity))">
                                                                <span class="flex items-center text-green-600">
                                                                    <i class="ri-arrow-right-line mx-1"></i>
                                                                    <span class="font-semibold" x-text="entity ? entity.new_name : ''"></span>
                                                                </span>
                                                            </template>
                                                        </div>
                                                    </div>

                                                    <!-- Status & Actions -->
                                                    <div class="flex items-center space-x-2">
                                                        <!-- Basename editing -->
                                                        <div class="flex items-center space-x-1">
                                                            <span class="text-xs text-gray-500" x-text="t('entity.basename')"></span>
                                                            <template x-if="entity && !entity.editing">
                                                                <code class="text-xs font-mono cursor-pointer hover:underline"
                                                                      :class="entity ? (entity.has_override ? 'text-blue-700' : (entity.current_basename ? 'text-gray-700' : (entityRequiresManualBasename(entity) ? 'text-red-600' : 'text-amber-700'))) : 'text-gray-500'"
                                                                      x-text="entity ? (entity.has_override ? entity.override_name : (entity.current_basename || (entityRequiresManualBasename(entity) ? t('entity.click_to_edit') : getEntitySuggestion(entity)))) : ''"
                                                                      @click="startEntityEdit(entity)"></code>
                                                            </template>
                                                            <!-- Accept current basename button -->
                                                            <button x-show="entity && !entity.editing && !entity.has_override && entity.current_basename"
                                                                    @click.stop="acceptCurrentBasename(entity)"
                                                                    class="text-green-600 hover:text-green-700 hover:bg-green-50 rounded p-0.5 transition-colors"
                                                                    :title="t('entity.accept_current_basename')">
                                                                <i class="ri-check-line text-sm"></i>
                                                            </button>
                                                            <template x-if="entity && entity.editing">
                                                                <input type="text"
                                                                       x-model="entity.override_name"
                                                                       @keyup.enter="saveEntityEdit(entity)"
                                                                       @keyup.escape.stop="cancelEntityEdit(entity)"
                                                                       @blur="handleEntityBlur($event, entity)"
                                                                       class="text-xs font-mono px-1 py-0.5 border border-amber-500 rounded focus:ring-1 focus:ring-blue-500"
                                                                       placeholder="Basename"
                                                                       x-init="$nextTick(() => $el.focus())">
                                                            </template>
                                                        </div>

                                                        <!-- Status badges -->
                                                        <button x-show="entity && entity.needs_rename && !entity.has_override && !entity.current_basename && !entityRequiresManualBasename(entity)"
                                                                @click.stop="acceptEntitySuggestion(entity)"
                                                                class="text-xs px-1.5 py-0.5 rounded-full bg-amber-100 text-amber-700 hover:bg-amber-200 transition-colors"
                                                                :title="t('entity.accept_suggestion')">
                                                            <span x-text="t('entity.suggestion')"></span>
                                                        </button>
                                                        <!-- Accept button for entities with correct names -->
                                                        <button x-show="entity && !entity.needs_rename && !entity.has_maintained_label"
                                                                @click.stop="acceptCurrentName(entity)"
                                                                class="text-xs px-1.5 py-0.5 rounded-full bg-green-100 text-green-700 hover:bg-green-200 transition-colors"
                                                                :title="t('entity.accept_current_name')">
                                                            <i class="ri-check-line mr-0.5"></i>
                                                            <span x-text="t('entity.accept')"></span>
                                                        </button>
                                                        <span x-show="entity && entity.needs_rename && !entity.has_override && entityRequiresManualBasename(entity)"
                                                              class="text-xs px-1.5 py-0.5 rounded-full bg-red-100 text-red-700"
                                                              title="Manueller Basename erforderlich">
                                                            <span x-text="t('entity.input_required')"></span>
                                                        </span>
                                                        <span x-show="entity && entity.needs_rename && entity.has_override"
                                                              class="text-xs px-1.5 py-0.5 rounded-full bg-blue-100 text-blue-700">
                                                            <span x-text="t('entity.override')"></span>
                                                        </span>
                                                        <span x-show="entity && !entity.needs_rename && entity.has_maintained_label"
                                                              class="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded-full">
                                                            <i class="ri-check-line"></i> <span x-text="t('entity.maintained')"></span>
                                                        </span>
                                                        <!-- Show selected state for entities marked for acceptance -->
                                                        <span x-show="entity && !entity.needs_rename && entity.selected && !entity.has_maintained_label"
                                                              class="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded-full">
                                                            <i class="ri-checkbox-circle-line mr-0.5"></i> <span x-text="t('entity.marked_for_acceptance')"></span>
                                                        </span>
                                                        <span x-show="entity && entity.disabled_by"
                                                              class="text-xs px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded-full"
                                                              :title="t('entity.disabled_by') + ' ' + (entity ? entity.disabled_by : '')">
                                                            <i class="ri-eye-close-line"></i> <span x-text="t('entity.disabled')"></span>
                                                        </span>

                                                        <!-- Dependencies link -->
                                                        <button @click.stop="entity && showDependencies(entity.old_id)"
                                                                class="text-xs text-blue-600 hover:text-blue-700 ml-auto">
                                                            <i class="ri-links-line"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    </template>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- No Results -->
            <div x-show="!loading && changes.length === 0 && selectedArea && selectedDomain" x-cloak
                 class="bg-white rounded-lg shadow-sm p-12 text-center">
                <i class="ri-inbox-line text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600" x-text="t('entity.no_entities_found')"></p>
            </div>
            </div>
        </main>

        <!-- Dependencies Modal -->
        <div x-show="showDependencyModal" x-cloak
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
             @click.self="showDependencyModal = false">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold"><span x-text="t('dependencies.title')"></span> <code x-text="currentEntityId" class="text-sm bg-gray-100 px-2 py-1 rounded"></code></h3>
                </div>
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <div x-show="!dependencyData" class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    </div>
                    <div x-show="dependencyData" class="space-y-4">
                        <template x-for="(deps, type) in dependencyData" :key="type">
                            <div x-show="deps && deps.length > 0">
                                <h4 class="font-medium text-gray-700 mb-2" x-text="`${type} (${deps.length})`"></h4>
                                <ul class="space-y-1">
                                    <template x-for="(dep, index) in deps" :key="`${type}-${index}`">
                                        <li class="text-sm text-gray-600 pl-4">
                                            <i class="ri-arrow-right-s-line text-gray-400"></i>
                                            <span x-text="dep"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                        <div x-show="!dependencyData || Object.keys(dependencyData).length === 0" class="text-center text-gray-500">
                            <span x-text="t('dependencies.no_dependencies')"></span>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50">
                    <button @click="showDependencyModal = false"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        <span x-text="t('buttons.close')"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div x-show="message" x-cloak
             class="fixed bottom-4 right-4 max-w-md"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0">
            <div class="rounded-lg shadow-lg p-4"
                 :class="messageType === 'success' ? 'bg-green-100 text-green-800' : messageType === 'warning' ? 'bg-amber-100 text-amber-800' : 'bg-red-100 text-red-800'">
                <div class="flex items-center">
                    <i :class="messageType === 'success' ? 'ri-checkbox-circle-line' : 'ri-error-warning-line'"
                       class="text-xl mr-3"></i>
                    <p x-text="message"></p>
                </div>
            </div>
        </div>

        <!-- Device Rename Modal -->
        <div x-show="deviceRenameModal" x-cloak
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
             @click.self="deviceRenameModal = false">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="p-6 border-b">
                    <h3 class="text-lg font-semibold" x-text="t('device.rename_device')"></h3>
                </div>
                <div class="p-6">
                    <div x-show="selectedDevice">
                        <p class="text-sm text-gray-600 mb-4">
                            <span x-text="t('device.current_name') + ':'" class="mr-1"></span><span class="font-medium" x-text="selectedDevice?.name"></span>
                        </p>
                        <label class="block text-sm font-medium text-gray-700 mb-2" x-text="t('device.new_name')"></label>
                        <input type="text" x-model="newDeviceName"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               @keyup.enter="saveDeviceRename()">
                        <p class="text-xs text-gray-500 mt-2">
                            <span x-text="t('device.rename_note')"></span>
                        </p>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 flex justify-end space-x-2">
                    <button @click="deviceRenameModal = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        <span x-text="t('buttons.cancel')"></span>
                    </button>
                    <button @click="saveDeviceRename()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <span x-text="t('buttons.rename')"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function entityManager() {
            return {
                areas: [],
                selectedArea: '',
                selectedDomain: 'all',
                availableDomains: [],
                skipReviewed: false,
                onlyChanges: false,
                showDisabled: false,
                changes: [],
                loading: false,
                executing: false,
                previewId: '',
                needRenameCount: 0,
                selectedCount: 0,
                selectedDeviceCount: 0,
                totalEntities: 0,
                stats: {},
                t: (key, params) => key, // Translation function with fallback
                message: '',
                messageType: 'success',
                showDependencyModal: false,
                currentEntityId: '',
                dependencyData: null,
                deviceRenameModal: false,
                selectedDevice: null,
                newDeviceName: '',
                editingAreaName: false,
                areaOverrideName: '',
                selectedAreaData: null,
                savedFilters: null,

                async init() {
                    try {
                        // Initialize translations
                        if (window.translations) {
                            console.log('Translation system found, initializing...');
                            await window.translations.init();
                            this.t = (key, params) => window.translations.t(key, params);
                            console.log('Translation function ready, testing:', this.t('header.title'));

                            // Update page title
                            document.title = this.t('header.title');

                            // Force Alpine to re-evaluate all expressions
                            this.$nextTick(() => {
                                console.log('Forcing Alpine refresh');
                            });
                        } else {
                            console.error('Translation system not loaded');
                            // Keep the fallback function
                        }
                    } catch (error) {
                        console.error('Error initializing translations:', error);
                        // Keep the fallback function
                    }

                    // Try to restore filters from localStorage (works in iframe)
                    try {
                        const savedFilters = localStorage.getItem('entityManagerFilters');
                        if (savedFilters) {
                            const filters = JSON.parse(savedFilters);
                            if (filters.skipReviewed !== undefined) {
                                this.skipReviewed = filters.skipReviewed;
                            }
                            if (filters.onlyChanges !== undefined) {
                                this.onlyChanges = filters.onlyChanges;
                            }
                            if (filters.showDisabled !== undefined) {
                                this.showDisabled = filters.showDisabled;
                            }
                            // We'll restore area and domain after loading areas
                            this.savedFilters = filters;
                        }
                    } catch (e) {
                        console.error('Error loading saved filters:', e);
                    }

                    // Lade Areas
                    await this.loadAreas();

                    // Restore saved filters if available
                    if (this.savedFilters) {
                        const { area, domain } = this.savedFilters;

                        if (area && this.areas.find(a => a.name === area)) {
                            this.selectedArea = area;
                            this.onAreaChange(false); // false = don't save to storage yet

                            if (domain && (domain === 'all' || this.availableDomains.includes(domain))) {
                                this.selectedDomain = domain;
                                // Lade Preview automatisch
                                await this.loadPreview();
                            }
                        }
                    }
                },

                saveFilters() {
                    // Save filters to localStorage for persistence in iframe
                    try {
                        const filters = {
                            area: this.selectedArea,
                            domain: this.selectedDomain,
                            skipReviewed: this.skipReviewed,
                            onlyChanges: this.onlyChanges,
                            showDisabled: this.showDisabled
                        };
                        localStorage.setItem('entityManagerFilters', JSON.stringify(filters));
                    } catch (e) {
                        console.error('Error saving filters:', e);
                    }
                },

                async loadAreas() {
                    try {
                        const response = await fetch('api/areas');
                        this.areas = await response.json();

                        // Load stats
                        const statsResponse = await fetch('api/stats');
                        this.stats = await statsResponse.json();
                    } catch (error) {
                        this.showMessage(this.t('messages.error_loading_areas'), 'error');
                    }
                },

                getAreaDisplayName(area) {
                    if (!area) return '';
                    // Check if this is the unassigned area marker
                    if (area.name === '__unassigned__' || area.display_name === '__unassigned__') {
                        return this.t('filters.unassigned_area');
                    }
                    return area.display_name || area.name;
                },

                onAreaChange(updateUrl = true) {
                    // Speichere die aktuelle Domain
                    const previousDomain = this.selectedDomain;

                    this.selectedDomain = 'all';  // Default to "all" instead of empty
                    this.changes = [];

                    if (this.selectedArea) {
                        const area = this.areas.find(a => a.name === this.selectedArea);
                        this.selectedAreaData = area;
                        this.availableDomains = area ? area.domains : [];

                        // Wenn die vorherige Domain auch im neuen Raum existiert, behalte sie
                        if (previousDomain && previousDomain !== 'all' && this.availableDomains.includes(previousDomain)) {
                            this.selectedDomain = previousDomain;
                        }

                        // Lade automatisch die Preview mit "all" domains
                        this.loadPreview();
                    } else {
                        this.availableDomains = [];
                    }

                    if (updateUrl) {
                        this.saveFilters();
                    }
                },

                async onDomainChange() {
                    this.saveFilters();
                    // Automatisch laden wenn beide Filter gesetzt sind
                    if (this.selectedArea && this.selectedDomain) {
                        await this.loadPreview();
                    }
                },

                async loadPreview() {
                    if (!this.selectedArea || !this.selectedDomain) return;

                    this.loading = true;
                    this.changes = [];
                    this.saveFilters();

                    try {
                        const response = await fetch('api/preview', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                area: this.selectedArea,
                                domain: this.selectedDomain,
                                skip_reviewed: this.skipReviewed,
                                only_changes: this.onlyChanges,
                                show_disabled: this.showDisabled
                            })
                        });

                        const data = await response.json();
                        this.previewId = data.preview_id;
                        this.changes = data.changes;
                        this.needRenameCount = data.need_rename;
                        this.totalEntities = data.total;

                        // Debug: Check data structure
                        console.log('Preview data received:', {
                            totalGroups: this.changes.length,
                            firstGroup: this.changes[0],
                            isGrouped: this.changes[0]?.device !== undefined
                        });

                        this.updateSelectedCount();
                    } catch (error) {
                        console.error('Fehler beim Laden:', error);
                        const errorMsg = error.response?.data?.error || error.message || 'Unbekannter Fehler';
                        this.showMessage(`Fehler beim Laden der Entities: ${errorMsg}`, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                updateSelectedCount() {
                    let count = 0;
                    let deviceCount = 0;
                    this.changes.forEach(deviceGroup => {
                        if (deviceGroup && deviceGroup.device && deviceGroup.device.selected) {
                            deviceCount++;
                        }
                        if (deviceGroup && deviceGroup.entities) {
                            count += deviceGroup.entities.filter(e => e && e.selected).length;
                        }
                    });
                    this.selectedCount = count;
                    this.selectedDeviceCount = deviceCount;
                },

                updateCounts() {
                    // Update the need rename count
                    let needRename = 0;
                    this.changes.forEach(deviceGroup => {
                        if (deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename) {
                            needRename++;
                        }
                        if (deviceGroup && deviceGroup.entities) {
                            needRename += deviceGroup.entities.filter(e => e && e.needs_rename).length;
                        }
                    });
                    this.needRenameCount = needRename;
                },

                selectAll() {
                    this.changes.forEach(deviceGroup => {
                        if (deviceGroup && deviceGroup.entities) {
                            deviceGroup.entities.forEach(e => {
                                // Only select entities that can be selected
                                if (e && this.entityCanBeSelected(e)) {
                                    e.selected = true;
                                }
                            });
                        }
                        if (deviceGroup && deviceGroup.device && deviceGroup.device.needs_rename) {
                            deviceGroup.device.selected = true;
                        }
                    });
                    this.updateSelectedCount();
                },

                selectNone() {
                    this.changes.forEach(deviceGroup => {
                        if (deviceGroup && deviceGroup.entities) {
                            deviceGroup.entities.forEach(e => {
                                if (e) e.selected = false;
                            });
                        }
                        if (deviceGroup && deviceGroup.device) {
                            deviceGroup.device.selected = false;
                        }
                    });
                    this.updateSelectedCount();
                },

                getExecuteButtonText() {
                    if (!this.t) return 'Execute changes';

                    let text = [];
                    if (this.selectedDeviceCount > 0) {
                        const deviceText = this.selectedDeviceCount === 1
                            ? this.t('device.count_singular')
                            : this.t('device.count_plural');
                        text.push(`${this.selectedDeviceCount} ${deviceText}`);
                    }
                    if (this.selectedCount > 0) {
                        text.push(`${this.selectedCount} ${this.t('units.entities')}`);
                    }

                    if (text.length === 0) {
                        return this.t('buttons.execute_changes');
                    }

                    return text.join(' & ') + ' ' + this.t('buttons.execute_changes').toLowerCase();
                },

                getDevicePreviewName(device) {
                    if (!device) return '';
                    // Device override is the full device name, suggested_name is the full suggested name
                    return device.override_name || device.suggested_name;
                },

                getEntitySuggestion(entity) {
                    if (!entity || !entity.new_id) return '';

                    // Get the entity domain (first part before the dot)
                    const idParts = entity.new_id.split('.');
                    const domain = idParts[0];
                    
                    // First, try to get a translated name for the domain
                    const domainTranslation = this.t(`entity_types.${domain}`);
                    
                    // If we have a translation for this domain and it's not just the key itself
                    if (domainTranslation && domainTranslation !== `entity_types.${domain}`) {
                        // For some domains, we might want to extract more specific info from the entity ID
                        if (idParts.length > 1 && ['light', 'switch', 'cover', 'fan', 'lock'].includes(domain)) {
                            const entityPart = idParts[1];
                            const underscoreParts = entityPart.split('_');
                            
                            // Try to find a meaningful suffix that describes the specific type
                            let specificType = underscoreParts[underscoreParts.length - 1];
                            
                            // If the last part is just the domain name, use the domain translation
                            if (specificType === domain || specificType === domain + 's') {
                                return domainTranslation;
                            }
                            
                            // Try to get a translation for the specific type
                            const specificTranslation = this.t(`entity_types.${specificType}`);
                            if (specificTranslation && specificTranslation !== `entity_types.${specificType}`) {
                                return specificTranslation;
                            }
                            
                            // Otherwise, capitalize and return the specific type
                            return specificType.charAt(0).toUpperCase() + specificType.slice(1);
                        }
                        
                        // For other domains, just return the domain translation
                        return domainTranslation;
                    }
                    
                    // If no translation found, return empty string for domains that typically need manual input
                    // This can be configured in the translation file by not providing a translation
                    
                    // Fallback: try to extract something meaningful from the entity ID
                    if (idParts.length > 1) {
                        const entityPart = idParts[1];
                        const underscoreParts = entityPart.split('_');
                        let entityType = underscoreParts[underscoreParts.length - 1];
                        
                        if (entityType === domain && underscoreParts.length > 1) {
                            entityType = underscoreParts[underscoreParts.length - 2];
                        }
                        
                        return entityType.charAt(0).toUpperCase() + entityType.slice(1);
                    }
                    
                    return '';
                },

                getEntityPreviewId(entity) {
                    if (!entity) return '';

                    // Während der Bearbeitung immer berechnen
                    if (!entity.editing && !entity.needs_rename) {
                        return entity.new_id || ''; // Verwende die vom Backend berechnete ID
                    }

                    // Wenn kein Override Name vorhanden (während Bearbeitung), verwende leeren String
                    if (!entity.override_name) {
                        return entity.new_id || '';
                    }

                    // Extrahiere Domain
                    const idParts = entity.new_id.split('.');
                    if (idParts.length < 2) return entity.new_id;
                    const domain = idParts[0];

                    // Finde das Device zu dieser Entity
                    let roomName = null;
                    let deviceBaseName = null;

                    for (let change of this.changes) {
                        // Prüfe ob die Entity zu diesem Device gehört
                        if (change && change.device && change.entities && change.entities.some(e => e && e.old_id === entity.old_id)) {
                            const device = change.device;

                            // Get full device name (override or suggested name)
                            deviceBaseName = device.override_name || device.suggested_name;

                            // Extrahiere Raum aus Device suggested_name
                            const parts = device.suggested_name.split(' ');
                            roomName = parts[0].toLowerCase();
                            break;
                        }
                    }

                    // Fallback: Extrahiere Raum aus Entity ID wenn kein Device
                    if (!roomName) {
                        const entityPart = idParts[1];
                        const underscoreParts = entityPart.split('_');

                        const knownRooms = ['wohnzimmer', 'buro', 'kuche', 'schlafzimmer', 'badezimmer',
                                          'kinderzimmer', 'eingang', 'diele', 'balkon', 'kammer', 'dusche', 'keller'];

                        for (let part of underscoreParts) {
                            if (knownRooms.includes(part)) {
                                roomName = part;
                                break;
                            }
                        }
                    }

                    // Normalisiere alle Teile
                    const normalizeString = (str) => {
                        return str.toLowerCase()
                            .replace(/ä/g, 'a').replace(/ö/g, 'o').replace(/ü/g, 'u')
                            .replace(/ß/g, 'ss').replace(/[^a-z0-9]+/g, '_')
                            .replace(/_+/g, '_').replace(/^_|_$/g, '');
                    };

                    // Baue neue Entity ID: Raum_Device_Entity
                    const parts = [];
                    if (roomName) parts.push(normalizeString(roomName));
                    if (deviceBaseName) parts.push(normalizeString(deviceBaseName));
                    parts.push(normalizeString(entity.override_name));

                    return `${domain}.${parts.join('_')}`;
                },

                getEntityFriendlyName(entity) {
                    if (!entity) return '';

                    // Während der Bearbeitung immer berechnen
                    if (!entity.editing && !entity.needs_rename) {
                        return entity.new_name || ''; // Verwende den vom Backend berechneten Namen
                    }

                    // Wenn kein Override Name vorhanden, verwende den vom Backend berechneten Namen
                    if (!entity.override_name) {
                        return entity.new_name || '';
                    }

                    // Finde das Device zu dieser Entity
                    let deviceName = null;
                    let roomName = null;

                    for (let change of this.changes) {
                        // Prüfe ob die Entity zu diesem Device gehört
                        if (change && change.device && change.entities && change.entities.some(e => e && e.old_id === entity.old_id)) {
                            // Get full device name (override or suggested name)
                            const device = change.device;
                            deviceName = device.override_name || device.suggested_name;

                            // Extrahiere Raum aus Device suggested_name
                            const parts = device.suggested_name.split(' ');
                            roomName = parts[0];
                            break;
                        }
                    }

                    // Wenn kein Device, extrahiere Raum aus Entity ID
                    if (!roomName) {
                        const idParts = entity.new_id.split('.');
                        if (idParts.length > 1) {
                            const entityPart = idParts[1];
                            const underscoreParts = entityPart.split('_');

                            const knownRooms = ['wohnzimmer', 'buro', 'kuche', 'schlafzimmer', 'badezimmer',
                                              'kinderzimmer', 'eingang', 'diele', 'balkon', 'kammer', 'dusche', 'keller'];

                            for (let part of underscoreParts) {
                                if (knownRooms.includes(part)) {
                                    roomName = part.replace('buro', 'büro').replace('kuche', 'küche');
                                    roomName = roomName.charAt(0).toUpperCase() + roomName.slice(1);
                                    break;
                                }
                            }
                        }
                    }

                    // Baue Friendly Name
                    const parts = [];
                    if (roomName) parts.push(roomName);
                    if (deviceName && !roomName.toLowerCase().includes(deviceName.toLowerCase())) {
                        parts.push(deviceName);
                    }
                    parts.push(entity.override_name);

                    return parts.join(' ');
                },

                entityRequiresManualBasename(entity) {
                    if (!entity || !entity.new_id) return false;
                    
                    const idParts = entity.new_id.split('.');
                    const domain = idParts[0];
                    
                    // Get the list of domains requiring manual basename from config
                    if (window.EntityManagerConfig && window.EntityManagerConfig.entityTypesRequiringManualBasename) {
                        return window.EntityManagerConfig.entityTypesRequiringManualBasename.includes(domain);
                    }
                    
                    // Fallback to empty suggestion check
                    return this.getEntitySuggestion(entity) === '';
                },

                entityCanBeSelected(entity) {
                    // Entity can be selected if:
                    // 1. It needs renaming (ID or name change), OR
                    // 2. It doesn't have the maintained label yet
                    // BUT NOT if it requires manual basename (unless it has an override)
                    if (!entity.has_override && this.entityRequiresManualBasename(entity)) {
                        return false;
                    }
                    return entity.needs_rename || !entity.has_maintained_label;
                },

                toggleSelection(entity) {
                    if (this.entityCanBeSelected(entity)) {
                        entity.selected = !entity.selected;
                        this.updateSelectedCount();
                    }
                },

                toggleDeviceSelection(device) {
                    device.selected = !device.selected;

                    // Wenn Device ausgewählt wird, deselektiere alle seine Entities
                    if (device.selected) {
                        this.changes.forEach(deviceGroup => {
                            if (deviceGroup.device && deviceGroup.device.id === device.id) {
                                deviceGroup.entities.forEach(entity => {
                                    entity.selected = false;
                                });
                            }
                        });
                    }

                    this.updateSelectedCount();
                },

                startDeviceEdit(device) {
                    device.editing = true;
                    // Save original value for cancel
                    device._original_override_name = device.override_name;
                    // Show override if exists, otherwise the suggested full name
                    device.override_name = device.has_override ? device.override_name : device.suggested_name;

                    // Focus will be handled by x-init on the input element
                },

                cancelDeviceEdit(device) {
                    device.editing = false;
                    // Stelle den ursprünglichen Zustand wieder her
                    if (device._original_override_name !== undefined) {
                        device.override_name = device._original_override_name;
                        delete device._original_override_name;
                    } else if (!device.has_override) {
                        // Wenn kein Override existiert, lösche override_name
                        delete device.override_name;
                    }
                },

                handleDeviceBlur(event, device) {
                    // Kleine Verzögerung um zu prüfen ob Enter gedrückt wurde
                    setTimeout(() => {
                        if (device.editing) {
                            this.cancelDeviceEdit(device);
                        }
                    }, 200);
                },

                async saveDeviceEdit(device) {
                    device.editing = false;

                    try {
                        const response = await fetch('api/set_device_override', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                device_id: device.id,
                                override_name: device.override_name || null
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();

                            // Update device override status
                            device.has_override = result.device_has_override;

                            // Update device needs_rename status
                            const newDeviceName = this.getDevicePreviewName(device);
                            device.needs_rename = device.current_name !== newDeviceName;

                            // Update entity suggestions without reloading
                            if (result.updated_entities && result.updated_entities.length > 0) {
                                // Find the device group
                                const deviceGroup = this.changes.find(dg => dg.device && dg.device.id === device.id);
                                if (deviceGroup && deviceGroup.entities) {
                                    // Update each entity with new suggestions
                                    result.updated_entities.forEach(updatedEntity => {
                                        const entity = deviceGroup.entities.find(e => e.old_id === updatedEntity.old_id);
                                        if (entity) {
                                            // Preserve selection state
                                            const wasSelected = entity.selected;

                                            // Update entity data
                                            entity.new_id = updatedEntity.new_id;
                                            entity.new_name = updatedEntity.new_name;
                                            entity.needs_rename = updatedEntity.needs_rename;
                                            entity.has_override = updatedEntity.has_override;

                                            // Restore selection state
                                            entity.selected = wasSelected;

                                            // If entity can no longer be selected, deselect it
                                            if (!this.entityCanBeSelected(entity)) {
                                                entity.selected = false;
                                            }
                                        }
                                    });

                                    // Update counts
                                    this.updateCounts();
                                    this.updateSelectedCount();
                                }
                            }

                            this.showMessage(this.t('messages.device_override_saved'), 'success');
                        } else {
                            const error = await response.json();
                            this.showMessage(`${this.t('messages.error')}: ${error.error}`, 'error');
                        }
                    } catch (error) {
                        this.showMessage(this.t('messages.error_saving_device_override'), 'error');
                    }
                },

                async saveDeviceRename() {
                    if (!this.selectedDevice || !this.newDeviceName.trim()) return;

                    try {
                        const response = await fetch('api/rename_device', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                device_id: this.selectedDevice.id,
                                new_name: this.newDeviceName.trim()
                            })
                        });

                        if (response.ok) {
                            this.showMessage(this.t('messages.device_renamed_successfully'), 'success');
                            this.deviceRenameModal = false;
                            // Reload preview to show updated entity names
                            await this.loadPreview();
                        } else {
                            const error = await response.json();
                            this.showMessage(`${this.t('messages.error')}: ${error.error}`, 'error');
                        }
                    } catch (error) {
                        this.showMessage(this.t('messages.error_renaming_device'), 'error');
                    }
                },

                async renameDeviceInHA(device) {
                    if (!device.has_override || !device.override_name) {
                        this.showMessage(this.t('messages.no_override_name_set'), 'warning');
                        return;
                    }


                    try {
                        const response = await fetch('api/rename_device_in_ha', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                device_id: device.id,
                                new_name: device.override_name
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showMessage(result.message || this.t('messages.device_renamed_successfully'), 'success');
                            // Reload preview to show updated names
                            await this.loadPreview();
                        } else {
                            const error = await response.json();
                            this.showMessage(`${this.t('messages.error')}: ${error.error}`, 'error');
                        }
                    } catch (error) {
                        this.showMessage(this.t('messages.error_renaming_device_in_ha'), 'error');
                    }
                },

                startEntityEdit(entity) {
                    // Set editing mode
                    entity.editing = true;
                    // Speichere den Original-Wert für Cancel
                    entity._original_override_name = entity.override_name;

                    // Wenn ein Override existiert, zeige diesen, sonst prüfe ob manueller Basename erforderlich
                    if (!entity.has_override) {
                        if (this.entityRequiresManualBasename(entity)) {
                            // Clear field for manual input
                            entity.override_name = '';
                        } else {
                            // Use the suggestion from getEntitySuggestion
                            entity.override_name = this.getEntitySuggestion(entity);
                        }
                    }

                    // Focus will be handled by x-init on the input element
                },

                cancelEntityEdit(entity) {
                    entity.editing = false;
                    // Stelle den ursprünglichen Zustand wieder her
                    if (entity._original_override_name !== undefined) {
                        entity.override_name = entity._original_override_name;
                        delete entity._original_override_name;
                    } else if (!entity.has_override) {
                        // Wenn kein Override existiert, lösche override_name
                        delete entity.override_name;
                    }
                },

                handleEntityBlur(event, entity) {
                    if (!entity) return;

                    // Kleine Verzögerung um zu prüfen ob Enter gedrückt wurde
                    setTimeout(() => {
                        if (entity && entity.editing) {
                            this.cancelEntityEdit(entity);
                        }
                    }, 200);
                },

                acceptCurrentName(entity) {
                    // Mark entity as "maintained" without changing its name
                    if (!entity || entity.has_maintained_label) return;

                    // Select the entity to include it in the execution
                    entity.selected = true;
                    this.updateSelectedCount();

                    // Show visual feedback
                    this.showMessage(this.t('messages.entity_marked_for_acceptance'), 'success');
                },

                acceptCurrentBasename(entity) {
                    // Accept the current basename extracted from friendly_name as override
                    if (!entity || !entity.current_basename) return;

                    entity.override_name = entity.current_basename;
                    this.saveEntityEdit(entity);
                },

                acceptEntitySuggestion(entity) {
                    if (!entity || !entity.new_id) return;

                    // Extrahiere einen schönen Namen aus der Entity ID
                    const idParts = entity.new_id.split('.');
                    if (idParts.length > 1) {
                        const entityPart = idParts[1];
                        const underscoreParts = entityPart.split('_');
                        const entityType = underscoreParts[underscoreParts.length - 1];
                        // Konvertiere zu schönem Namen mit Großbuchstaben
                        entity.override_name = entityType.charAt(0).toUpperCase() + entityType.slice(1);
                    } else {
                        entity.override_name = entity.new_id;
                    }
                    this.saveEntityEdit(entity);
                },

                async saveEntityEdit(entity) {
                    try {
                        const response = await fetch('api/set_entity_override', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                registry_id: entity.registry_id,
                                override_name: entity.override_name || null
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();

                            // Update entity with backend-calculated values
                            entity.has_override = result.has_override;
                            entity.new_id = result.new_id || entity.new_id;
                            entity.new_name = result.new_friendly_name || entity.new_name;

                            // Update needs_rename flag based on whether the ID changed
                            entity.needs_rename = entity.old_id !== entity.new_id;

                            // Jetzt erst editing auf false setzen
                            entity.editing = false;

                            // Zeige Erfolgsmeldung
                            this.showMessage(this.t('messages.override_saved'), 'success');
                        } else {
                            entity.editing = false;
                            const error = await response.json();
                            this.showMessage(`${this.t('messages.error')}: ${error.error}`, 'error');
                        }
                    } catch (error) {
                        entity.editing = false;
                        this.showMessage(this.t('messages.error_saving_entity_override'), 'error');
                    }
                },

                startAreaEdit() {
                    if (!this.selectedAreaData) return;
                    this.editingAreaName = true;
                    this.areaOverrideName = this.selectedAreaData.has_override ?
                        this.selectedAreaData.override_name : this.selectedAreaData.name;
                },

                cancelAreaEdit() {
                    this.editingAreaName = false;
                    this.areaOverrideName = '';
                },

                handleAreaBlur(event) {
                    // Kleine Verzögerung um zu prüfen ob Enter gedrückt wurde
                    setTimeout(() => {
                        if (this.editingAreaName) {
                            this.cancelAreaEdit();
                        }
                    }, 200);
                },

                async saveAreaEdit() {
                    this.editingAreaName = false;

                    if (!this.selectedAreaData || !this.selectedAreaData.area_id) {
                        this.showMessage(this.t('messages.no_area_selected'), 'error');
                        return;
                    }

                    try {
                        const response = await fetch('api/set_area_override', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                area_id: this.selectedAreaData.area_id,
                                override_name: this.areaOverrideName || null
                            })
                        });

                        if (response.ok) {
                            // Reload the page to ensure all entity suggestions are recalculated with the new area name
                            window.location.reload();
                        } else {
                            const error = await response.json();
                            this.showMessage(`${this.t('messages.error')}: ${error.error}`, 'error');
                        }
                    } catch (error) {
                        this.showMessage(this.t('messages.error_saving_area_override'), 'error');
                    }
                },

                async onFilterChange() {
                    this.saveFilters();
                    // Reload wenn beide Filter gesetzt sind
                    if (this.selectedArea && this.selectedDomain) {
                        await this.loadPreview();
                    }
                },

                async executeChanges() {
                    if (this.selectedCount === 0 && this.selectedDeviceCount === 0) return;


                    this.executing = true;
                    const selectedEntities = [];
                    const selectedDevices = [];

                    // Collect all selected entities and devices
                    this.changes.forEach(deviceGroup => {
                        if (deviceGroup.device && deviceGroup.device.selected) {
                            selectedDevices.push({
                                device_id: deviceGroup.device.id,
                                new_name: this.getDevicePreviewName(deviceGroup.device),
                                entities: deviceGroup.entities.map(e => e.old_id)
                            });
                        }
                        deviceGroup.entities.forEach(entity => {
                            if (entity.selected) {
                                selectedEntities.push(entity.old_id);
                            }
                        });
                    });

                    try {
                        const response = await fetch('api/execute', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                preview_id: this.previewId,
                                selected_entities: selectedEntities,
                                selected_devices: selectedDevices
                            })
                        });

                        const result = await response.json();

                        const successCount = result.success.length;
                        const failedCount = result.failed.length;
                        const skippedCount = result.skipped.length;
                        const warningCount = result.dependency_warnings ? result.dependency_warnings.length : 0;
                        const deviceSuccessCount = result.device_success ? result.device_success.length : 0;
                        const deviceFailedCount = result.device_failed ? result.device_failed.length : 0;

                        // Zeige detaillierte Erfolgsmeldung
                        let messageParts = [];

                        if (deviceSuccessCount > 0 || deviceFailedCount > 0) {
                            let deviceMsg = `${this.t('messages.devices_label')}: ${deviceSuccessCount} ${this.t('messages.successful')}`;
                            if (deviceFailedCount > 0) {
                                deviceMsg += `, ${deviceFailedCount} ${this.t('messages.failed')}`;
                            }
                            messageParts.push(deviceMsg);
                        }

                        if (successCount > 0 || failedCount > 0 || skippedCount > 0) {
                            let entityMsg = `${this.t('messages.entities_label')}: ${successCount} ${this.t('messages.successful')}`;
                            if (skippedCount > 0) {
                                entityMsg += `, ${skippedCount} ${this.t('messages.skipped')}`;
                            }
                            if (failedCount > 0) {
                                entityMsg += `, ${failedCount} Fehler`;
                            }
                            messageParts.push(entityMsg);
                        }

                        if (warningCount > 0) {
                            messageParts.push(`${warningCount} ${this.t('messages.dependency_warnings')}`);
                        }

                        const message = messageParts.join(' | ');

                        const hasErrors = failedCount > 0 || deviceFailedCount > 0;
                        this.showMessage(message, hasErrors ? 'error' : warningCount > 0 ? 'warning' : 'success');

                        // Zeige Dependency Warnings wenn vorhanden
                        if (warningCount > 0) {
                            this.showDependencyWarnings(result.dependency_warnings);
                        }

                        // Warte kurz, damit Home Assistant die Änderungen verarbeiten kann
                        setTimeout(async () => {
                            // Lade zuerst die Areas neu (damit die Entity-Listen aktualisiert werden)
                            await this.loadAreas();
                            // Dann lade die Preview
                            await this.loadPreview();
                        }, 1500);
                    } catch (error) {
                        this.showMessage(this.t('messages.error_executing_changes'), 'error');
                    } finally {
                        this.executing = false;
                    }
                },

                async showDependencies(entityId) {
                    this.currentEntityId = entityId;
                    this.showDependencyModal = true;
                    this.dependencyData = null;

                    try {
                        const response = await fetch(`api/dependencies/${encodeURIComponent(entityId)}`);
                        this.dependencyData = await response.json();
                    } catch (error) {
                        this.dependencyData = { error: this.t('messages.error_loading_dependencies') };
                    }
                },

                showMessage(msg, type = 'success') {
                    this.message = msg;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, type === 'warning' ? 10000 : 5000);
                },

                showDependencyWarnings(warnings) {
                    // Erstelle eine detaillierte Warnung
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'fixed bottom-20 right-4 max-w-md bg-amber-100 border border-amber-400 text-amber-700 px-4 py-3 rounded-lg shadow-lg';
                    warningDiv.innerHTML = `
                        <div class="flex items-start">
                            <i class="ri-alert-line text-xl mr-3 mt-0.5"></i>
                            <div>
                                <p class="font-semibold">${this.t('messages.dependencies_update_warning_title')}</p>
                                <p class="text-sm mt-1">${this.t('messages.dependencies_update_warning_desc')}</p>
                                <ul class="text-sm mt-2 space-y-1">
                                    ${warnings.map(w => `<li class="flex items-center"><i class="ri-arrow-right-s-line mr-1"></i><code class="bg-amber-50 px-1 rounded">${w.entity_id}</code></li>`).join('')}
                                </ul>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                                <i class="ri-close-line text-xl hover:text-amber-900"></i>
                            </button>
                        </div>
                    `;
                    document.body.appendChild(warningDiv);

                    // Automatisch nach 15 Sekunden entfernen
                    setTimeout(() => {
                        if (warningDiv.parentElement) {
                            warningDiv.remove();
                        }
                    }, 15000);
                }
            }
        }
    </script>
</body>
</html>
